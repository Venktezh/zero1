<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ClearCache | Circulars</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    .circulars-section {
      max-width: 900px; margin: 48px auto 32px; padding: 0 12px 32px;
      border-radius: 14px; background: var(--panel-bg,#f5f7fb); box-shadow: 0 2px 18px #0001;
    }
    .circulars-section h2 {
      font-size: 2rem; font-weight: 700; text-align: center; color: var(--primary,#134d72);
      margin: 0 0 6px; letter-spacing: 1px;
    }
    .subnote { text-align:center; color:#667; margin:0 0 28px; font-size:.92rem; }
    .group-block { margin-bottom: 32px;}
    .group-title { color:#fff; background:#2e6da4; padding:10px 20px; border-radius:7px 7px 0 0; font-weight:700; }
    .circular {
      background:var(--card-bg,#fff); margin:0 0 13px; padding:15px 19px; border-radius:0 0 8px 8px;
      box-shadow:0 2px 7px #0001; border-left:5px solid #2e6da4; display:flex; flex-direction:column; gap:5px;
    }
    .circular-title { font-size:1.12em; font-weight:700; color:#2e6da4; }
    .circular-date  { color:#888; font-size:.96em; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;}
    .circular-link  { color:#126118; text-decoration:underline; }
    .circular-desc  { font-size:.99em; color:var(--primary); }
    .empty { color:var(--primary,#134d72); font-style:italic; }
    .error { color:#c03232; }
    @media (max-width:600px){ .circulars-section{padding:7px;} .group-title{font-size:1em;padding:8px 6px;} .circulars-section h2{font-size:1.2em;} }
  </style>
</head>
<body>
  <header style="position:relative;">
    <h1>ClearCache</h1>
    <p class="tagline">Minimal digital workspace</p>
    <button id="theme-toggle" aria-label="Toggle light or dark theme"
      style="position:absolute;right:2.2rem;top:2.3rem;background:none;border:none;cursor:pointer;font-size:1.75rem;color:var(--primary);">
      ðŸŒ™
    </button>
  </header>

  <nav aria-label="Main navigation">
    <div class="nav-container">
      <a href="index.html" class="nav-item">Home</a>
      <a href="about.html" class="nav-item">About</a>
      <a href="circulars.html" class="nav-item active">Circulars</a>
      <a href="game.html" class="nav-item">Game</a>
    </div>
  </nav>

  <main>
    <section class="circulars-section">
      <h2>NSE Circulars (Last 24 hours)</h2>
      <p id="window-note" class="subnote">Window: â€”</p>
      <div id="feed" style="margin-bottom:40px;min-height:70px;">Loading circularsâ€¦</div>
    </section>
  </main>

  <footer>
    <p>Â© ClearCache <span id="year"></span> | Venktezh</p>
  </footer>

  <script>
    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Theme toggle
    (function(){
      function getPreferredTheme(){ const s=localStorage.getItem('theme'); if(s) return s;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'; }
      function setTheme(t){ document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        const b=document.getElementById('theme-toggle');
        b.innerHTML = t==="dark" ? "ðŸŒž" : "ðŸŒ™";
        b.setAttribute('aria-label', t==="dark" ? "Switch to light theme":"Switch to dark theme"); }
      document.addEventListener('DOMContentLoaded',()=>{
        const btn=document.getElementById('theme-toggle'); if(!btn) return;
        let cur=getPreferredTheme(); setTheme(cur);
        btn.onclick=()=>{ cur=(cur==="dark"?"light":"dark"); setTheme(cur); };
      });
    })();

    // ---------- Timezone helpers (IST-safe without double-shifting) ----------
    // getTimezoneOffset(): minutes to add to local time to get UTC (e.g. IST = -330)
    const IST_OFFSET_MIN = -330;
    function toIST(date){
      const localOffsetMin = date.getTimezoneOffset();         // varies by user
      const deltaMin = IST_OFFSET_MIN - localOffsetMin;        // how much to move local time to be IST
      return new Date(date.getTime() + deltaMin*60*1000);
    }
    function formatIST(d){
      return d.toLocaleString("en-IN", {
        day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", hour12:false, timeZone: undefined
      }) + " IST";
    }

    // ---------- Robust date parsing (handles RSS, ISO, and common BSE styles) ----------
    function parseDateFlexible(s){
      if (!s) return null;
      // 1) Native parse (covers RFC822/RSS + ISO 8601)
      const n = new Date(s);
      if (!isNaN(n)) return n;

      // 2) DD-MMM-YYYY [HH:MM] (e.g., 26 Aug 2025 13:57 or 26-Aug-2025 13:57)
      let m = s.match(/^(\d{1,2})[ -](\w{3})[ -](\d{4})(?:[ ,T]+(\d{1,2}):(\d{2}))?/i);
      if (m){
        const [ , d, mon, y, hh='00', mm='00' ] = m;
        const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
        const mi = months[mon.toLowerCase()];
        if (mi>=0) return new Date(Date.UTC(+y, mi, +d, +hh, +mm)); // as UTC; timezone will be handled by toIST()
      }
      // 3) DD/MM/YYYY or DD-MM-YYYY
      m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
      if (m){
        const [ , d, mth, y ] = m;
        return new Date(Date.UTC(+y, +mth-1, +d, 0, 0));
      }
      return null; // could not parse
    }

    // ---------- Fetch & render (NSE) ----------
    const NSE_RSS = "https://nsearchives.nseindia.com/content/RSS/Circulars.xml";
    const RSS2JSON = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(NSE_RSS)}`;

    function stripHTML(html){
      const div=document.createElement('div'); div.innerHTML=html||'';
      return (div.textContent||div.innerText||'').replace(/\s+/g,' ').trim();
    }

    function withinLast24hIST(pubDateUTC){
      // Convert the *user's local view* of pubDate into IST-equivalent wall time
      const pubIST = toIST(pubDateUTC);
      const nowIST = toIST(new Date());
      const startIST = new Date(nowIST.getTime() - 24*60*60*1000);
      return pubIST >= startIST && pubIST <= nowIST;
    }

    async function loadNSELast24h(){
      const feedEl = document.getElementById("feed");
      try{
        const nowIST = toIST(new Date());
        const startIST = new Date(nowIST.getTime() - 24*60*60*1000);
        document.getElementById('window-note').textContent =
          `Window: ${formatIST(startIST)} â†’ ${formatIST(nowIST)}`;

        const res = await fetch(RSS2JSON, { headers:{ 'User-Agent':'Mozilla/5.0' } });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Parse dates robustly, then filter using the IST window
        const items = (data.items||[])
          .map(it => {
            const d = parseDateFlexible(it.pubDate);
            return d ? { ...it, _pub: d } : null;
          })
          .filter(Boolean)
          .filter(it => withinLast24hIST(it._pub))
          .sort((a,b) => b._pub - a._pub);

        // Grouping
        const groupDefs = [
          { title:"IPO / Listing Circulars (including SME IPO)", keywords:["IPO","listing","SME IPO"] },
          { title:"ASM / ESM / ST-ASM Circulars",               keywords:["ASM","ESM","ST-ASM"] },
        ];
        const grouped = [[],[]], rest=[];
        for(const it of items){
          const text = `${it.title||""} ${it.description||""}`.toLowerCase();
          let matched = false;
          for(let i=0;i<groupDefs.length;i++){
            for(const kw of groupDefs[i].keywords){
              if(text.includes(kw.toLowerCase())){ grouped[i].push(it); matched=true; break; }
            }
            if(matched) break;
          }
          if(!matched) rest.push(it);
        }

        const render = (it)=>{
          const wrap=document.createElement('div'); wrap.className='circular';
          const title=document.createElement('div'); title.className='circular-title';
          const a=document.createElement('a'); a.className='circular-link'; a.href=it.link; a.target="_blank"; a.rel="noopener noreferrer"; a.textContent=it.title||"Untitled";
          title.appendChild(a);
          const date=document.createElement('div'); date.className='circular-date'; date.textContent = formatIST(toIST(it._pub));
          const desc=document.createElement('div'); desc.className='circular-desc'; desc.textContent = stripHTML(it.description||it.content||"No summary available.");
          wrap.append(title,date,desc);
          return wrap;
        };

        feedEl.innerHTML = "";
        let rendered = 0;
        const addGroup = (title, arr, bg)=>{
          if(!arr.length) return;
          const block = document.createElement('div'); block.className='group-block';
          const gt = document.createElement('div'); gt.className='group-title'; if(bg) gt.style.background=bg; gt.textContent=title;
          block.appendChild(gt);
          arr.forEach(x => block.appendChild(render(x)));
          feedEl.appendChild(block);
          rendered += arr.length;
        };
        addGroup(groupDefs[0].title, grouped[0]);
        addGroup(groupDefs[1].title, grouped[1]);
        addGroup("Other Circulars", rest, "#4f4f4f");

        if(!rendered){
          feedEl.innerHTML = "<em class='empty'>No NSE circulars found in the last 24 hours.</em>";
        }
      } catch(e){
        console.error(e);
        document.getElementById("feed").innerHTML = `<span class='error'>Could not load circulars. Try reloading.</span>`;
      }
    }

    loadNSELast24h();
  </script>
</body>
</html>
